<script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
<script src="/socket.io/socket.io.js"></script>
<script>
  let socket = io();
  let timers = {};

  const app = Vue.createApp({
    data () {
      return {
        selected: null,
        currTime: 0,
        timers: {}
      }
    },

    methods: {
      setTimers (timers) {
        this.timers = timers;
      },
      setCurrTime (time) {
        this.currTime = time;
      },
      moveSelected (delta) {
        let keys = Object.keys(this.timers);
        let foundIndex = keys.indexOf(this.selected);
        if (foundIndex == -1) {
          if (delta > 0) {
            this.selected = keys[(keys.length + 0) % keys.length];
          } else {
            this.selected = keys[(keys.length + -1) % keys.length];
          }
        } else {
          this.selected = keys[(keys.length + foundIndex + delta) % keys.length]
        }
      },
    },
  });
</script>
<style>
* {
  font-family: monospace;
}

td > span {
  white-space: preserve;
}

.selected {
  background-color: yellow;
}
</style>
<body>
  <div id="app">
    <table>
      <tr>
        <td>Time Since Last</td>
        <td></td>
      </tr>
      <template :key="name" v-for="(timer, name) in timers">
        <tr :class="{ selected: name == selected }">
          <td>{{name}}</td>
          <td>
            <span>{{(Math.floor((currTime - timer) / (60 * 60 * 24))).toString().padStart(4, ' ')}}</span> days,
            <span>{{(Math.floor((currTime - timer) / (60 * 60)) % 24).toString().padStart(2, '0')}}</span> hours,
            <span>{{(Math.floor((currTime - timer) / 60) % 60).toString().padStart(2, '0')}}</span> minutes,
            <span>{{((currTime - timer) % 60).toFixed(3).padStart(6, '0')}}</span> seconds
          </td>
        </tr>
      </template>
    </table>
  </div>
  <script>
const mounted = app.mount('#app');
console.log("Mounted!");

socket.on("update", newTimers => {
  mounted.setTimers(newTimers);
});

window.onload = async () => {
  setInterval(() => {
    let currTime = Date.now() / 1000;
    mounted.setCurrTime(currTime);
  }, 47);

  document.addEventListener("keydown", async e => {
    if (e.key == "ArrowDown") {
      mounted.moveSelected(1);
    } else if (e.key == "ArrowUp") {
      mounted.moveSelected(-1);
    } else if (e.key == " ") {
      let name = mounted.selected;
      let timestamp = Date.now() / 1000;

      let params = new URLSearchParams({ name, timestamp });
      let url = "/reset?" + params.toString();
      let res = await fetch(url);

      console.log(`Url: ${url}\nStatus: ${res.status}\nResponse: ${await res.text()}`);
    }
  })
}
  </script>
</body>
